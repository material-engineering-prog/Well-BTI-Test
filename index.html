<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Well-BTIè¨ºæ–­ ğŸ’–ğŸŒˆ Well-Being MBTIé¢¨ãƒ†ã‚¹ãƒˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --border:#e5e7eb;
      --text-main:#111827;
      --text-sub:#6b7280;
      --accent:#2563eb;
      --accent-soft:rgba(37,99,235,.08);
      --h-color:#16a34a;
      --e-color:#ca8a04;
      --s-color:#2563eb;
      --r-color:#db2777;
      --danger:#ef4444;
      --shadow: 0 12px 28px rgba(17,24,39,.08);
    }
    *{box-sizing:border-box}
    body{
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: var(--bg);
      color: var(--text-main);
      margin:0;
    }
    .app-shell{min-height:100vh;display:flex;flex-direction:column}
    header{
      border-bottom:1px solid var(--border);
      background:#fff;
      position:sticky; top:0; z-index:10;
      backdrop-filter:saturate(180%) blur(6px);
    }
    .header-inner{
      max-width:980px;margin:0 auto;
      display:flex;align-items:center;justify-content:space-between;
      gap:1rem; padding:.75rem 1rem;
    }
    .logo{display:flex;align-items:center;gap:.6rem;font-weight:800}
    .logo-title{display:flex;flex-direction:column;line-height:1.1}
    .logo-title .name{font-size:1.05rem}
    .logo-title .sub{font-size:.78rem;color:var(--text-sub);font-weight:600}
    .user-badge{
      display:inline-flex;align-items:center;gap:.35rem;
      font-size:.8rem;color:var(--text-sub);
      border:1px solid var(--border);border-radius:999px;
      padding:.22rem .6rem;background:#fff;
      margin-left:.5rem;
    }
    nav{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:flex-end}
    nav button{
      border:1px solid transparent;
      background:transparent;
      color:var(--text-sub);
      cursor:pointer;
      padding:.35rem .6rem;
      border-radius:999px;
      font-size:.85rem;
    }
    nav button.active{
      background: var(--accent-soft);
      border-color: rgba(37,99,235,.25);
      color: var(--accent);
    }
    main{flex:1;padding:1.1rem 1rem 2rem}
    .container{max-width:980px;margin:0 auto}
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 1.1rem 1.25rem;
      margin-bottom: 1rem;
      box-shadow: var(--shadow);
    }
    h1,h2,h3{margin:0 0 .55rem 0}
    h1{font-size:1.45rem}
    h2{font-size:1.08rem}
    .muted{font-size:.88rem;color:var(--text-sub)}
    .small{font-size:.78rem}
    .pill{
      display:inline-flex;align-items:center;gap:.35rem;
      border-radius:999px;padding:.18rem .6rem;
      font-size:.75rem;background:#f9fafb;border:1px solid var(--border);
      color: var(--text-sub);
    }
    .section-title{display:flex;align-items:center;gap:.45rem;margin-bottom:.4rem}
    .grid{display:grid;gap:.75rem}
    @media (min-width: 720px){ .grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))} }
    label{font-size:.82rem;color:var(--text-sub)}
    select,input[type="text"]{
      width:100%;margin-top:.25rem;padding:.45rem .55rem;border-radius:.6rem;
      border:1px solid var(--border);background:#fff;color:var(--text-main);font-size:.9rem;
    }
    .toggle-row{display:flex;align-items:flex-start;gap:.55rem;font-size:.9rem}
    .toggle{
      width:40px;height:22px;border-radius:999px;background:#e5e7eb;
      padding:2px;display:flex;align-items:center;cursor:pointer;user-select:none;
      border:1px solid #d1d5db;
    }
    .toggle-thumb{
      width:18px;height:18px;border-radius:999px;background:#fff;
      transition:transform .15s ease;background .15s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,.08);
    }
    .toggle.on{background: rgba(37,99,235,.22); border-color: rgba(37,99,235,.35)}
    .toggle.on .toggle-thumb{transform:translateX(18px); background:#2563eb}
    button.primary{
      border:none;border-radius:999px;padding:.6rem 1.2rem;font-size:.92rem;font-weight:700;
      cursor:pointer;background:linear-gradient(120deg,#2563eb,#db2777);color:#fff;
      display:inline-flex;align-items:center;gap:.45rem;
    }
    button.secondary{
      border-radius:999px;border:1px solid var(--border);background:#fff;color:var(--text-main);
      padding:.52rem 1rem;font-size:.88rem;cursor:pointer;
    }
    button.ghost{
      border-radius:999px;border:1px dashed var(--border);background:#fff;color:var(--text-sub);
      padding:.45rem .9rem;font-size:.84rem;cursor:pointer;
    }
    button.primary:disabled{opacity:.5;cursor:not-allowed}
    .btn-row{display:flex;justify-content:flex-end;gap:.6rem;margin-top:.8rem;flex-wrap:wrap}

    /* quiz */
    .quiz-header{display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap}
    .quiz-toggle{display:flex;align-items:center;gap:.5rem}
    .page-indicator{font-size:.85rem;color:var(--text-sub)}
    .question{
      margin-bottom:.85rem;border-radius:1rem;padding:.85rem;background:#fff;
      border:1px solid var(--border);
    }
    .question-text{font-size:1rem;margin-bottom:.45rem}
    .scale-row{display:flex;flex-wrap:wrap;gap:.35rem;margin:.2rem 0 .25rem}
    .scale-option{
      font-size:.82rem;display:inline-flex;flex-direction:column;align-items:center;gap:.15rem;
      cursor:pointer;padding:.25rem .45rem;border-radius:.65rem;border:1px solid transparent;
      min-width: 56px;
    }
    .scale-option input{cursor:pointer}
    .scale-option.active{border-color:rgba(37,99,235,.55);background:var(--accent-soft);color:var(--accent)}
    .scale-caption{font-size:.76rem;color:var(--text-sub)}
    .axis-tag{
      font-size:.73rem;padding:.14rem .5rem;border-radius:999px;background:#fff;
      border:1px solid var(--border);display:inline-flex;align-items:center;gap:.25rem;
      margin-right:.25rem;margin-bottom:.25rem;
    }
    .axis-tag[data-axis="H"]{border-color:rgba(22,163,74,.35);color:var(--h-color)}
    .axis-tag[data-axis="E"]{border-color:rgba(202,138,4,.35);color:var(--e-color)}
    .axis-tag[data-axis="S"]{border-color:rgba(37,99,235,.35);color:var(--s-color)}
    .axis-tag[data-axis="R"]{border-color:rgba(219,39,119,.35);color:var(--r-color)}

    /* result */
    .result-main{display:grid;gap:1rem}
    @media (min-width: 860px){ .result-main{grid-template-columns:minmax(0,1.2fr) minmax(0,1fr)} }
    .type-title{font-size:1.25rem;font-weight:900;display:flex;align-items:center;gap:.45rem;margin-bottom:.2rem}
    .type-code{font-size:.85rem;color:var(--text-sub)}
    .badge-chip{
      display:inline-flex;align-items:center;gap:.2rem;padding:.16rem .5rem;border-radius:999px;
      font-size:.75rem;background:#fff;border:1px solid var(--border);margin-right:.25rem;margin-top:.15rem
    }
    .actions-list{list-style:none;padding-left:0;margin:.4rem 0 0;font-size:.92rem}
    .actions-list li{margin-bottom:.35rem;padding-left:.35rem;position:relative}
    .actions-list li::before{content:"ğŸŒ±";position:absolute;left:-1.05rem;top:.05rem;font-size:.85rem}
    .share-row{margin-top:.65rem;display:flex;flex-wrap:wrap;gap:.5rem;align-items:center}
    .share-input{
      flex:1;min-width:200px;border-radius:.65rem;border:1px solid var(--border);
      background:#fff;color:var(--text-main);padding:.38rem .55rem;font-size:.85rem;
    }
    canvas{
      border-radius:.9rem;width:100%;max-width:440px;height:auto;background:#fff;border:1px solid var(--border)
    }

    /* shortest move */
    .shortest-move{
      margin-top:.6rem;
      border:1px solid rgba(37,99,235,.25);
      background: rgba(37,99,235,.06);
      padding:.65rem .75rem;
      border-radius:.9rem;
      font-size:.95rem;
      line-height:1.35;
    }
    .shortest-move b{font-weight:900}

    /* history */
    .history-empty{font-size:.9rem;color:var(--text-sub)}
    .history-list{margin-top:.5rem;font-size:.9rem;max-height:220px;overflow-y:auto}
    .history-item{
      display:flex;justify-content:space-between;gap:.75rem;padding:.38rem 0;border-bottom:1px dashed #e5e7eb;
      cursor:pointer;
    }
    .history-item:hover{background:#f9fafb}
    .danger-link{color:var(--danger);font-size:.9rem;cursor:pointer;text-decoration:underline}

    /* mode toggle */
    .mode-row{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.55rem}
    .mode-btn{
      border-radius:999px;border:1px solid var(--border);background:#fff;color:var(--text-main);
      padding:.45rem .9rem;font-size:.85rem;cursor:pointer;font-weight:700;
    }
    .mode-btn.active{
      border-color: rgba(37,99,235,.45);
      background: var(--accent-soft);
      color: var(--accent);
    }

    /* rainbow heart svg size */
    .logo svg{width:34px;height:34px;flex:0 0 auto}
  </style>
</head>

<body>
<div class="app-shell">
  <header>
    <div class="header-inner">
      <div class="logo" aria-label="Well-BTI ãƒ­ã‚´">
        <svg viewBox="0 0 64 64" role="img" aria-label="è™¹ã®ãƒãƒ¼ãƒˆ">
          <defs>
            <linearGradient id="rainbow" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#ef4444"/>
              <stop offset="18%" stop-color="#f97316"/>
              <stop offset="36%" stop-color="#eab308"/>
              <stop offset="54%" stop-color="#22c55e"/>
              <stop offset="72%" stop-color="#3b82f6"/>
              <stop offset="90%" stop-color="#a855f7"/>
              <stop offset="100%" stop-color="#db2777"/>
            </linearGradient>
          </defs>
          <path fill="url(#rainbow)" d="M32 56s-18.7-11.4-26-22.3C-1 23.2 4.2 10 17 10c6 0 11 3.5 15 8 4-4.5 9-8 15-8 12.8 0 18 13.2 11 23.7C50.7 44.6 32 56 32 56z"/>
          <path fill="rgba(255,255,255,.35)" d="M20 16c-6 0-10 6-6 13 2 4 8 10 12 13-5-7-8-12-9-15-2-6 1-11 3-11z"/>
        </svg>
        <div class="logo-title">
          <div class="name">Well-BTIè¨ºæ–­</div>
          <div class="sub">ã€Œæœ€å¤§åŒ–ã€ã¨ã€ŒçŠ ç‰²ã€ã‚’å¯è¦–åŒ–ã™ã‚‹</div>
        </div>
        <div id="current-user-badge" class="user-badge" style="display:none;">ğŸ‘¤ <span id="current-user-name"></span></div>
      </div>

      <nav>
        <button type="button" class="nav-btn active" data-target="onboarding-section">ğŸŸ¢ ã¯ã˜ã‚ã‚‹</button>
        <button type="button" class="nav-btn" data-target="quiz-section">ğŸ“ è¨ºæ–­</button>
        <button type="button" class="nav-btn" data-target="result-section">ğŸ¯ çµæœ</button>
        <button type="button" class="nav-btn" data-target="history-section">ğŸ“ˆ å±¥æ­´</button>
      </nav>
    </div>
  </header>

  <main>
    <div class="container">

      <!-- Onboarding -->
      <section id="onboarding-section">
        <div class="card">
          <h1>Well-BTIè¨ºæ–­ã¸ã‚ˆã†ã“ã ğŸ’–ğŸŒˆ</h1>
          <p class="muted">
            ã“ã‚Œã¯ã€Œè‰¯ã„/æ‚ªã„ã€ã§ã¯ãªãã€ã‚ãªãŸãŒ <strong>ä½•ã‚’æœ€å¤§åŒ–ã—ã€ä½•ã‚’çŠ ç‰²ã«ã—ãŒã¡ã‹</strong> ã‚’è¨€èªåŒ–ã™ã‚‹è¨ºæ–­ã§ã™ã€‚<br/>
            <strong>4è»¸ï¼ˆH/E/S/Rï¼‰</strong>ã‚’ã‚¹ã‚³ã‚¢åŒ–ã—ã€<strong>1ä½è»¸ Ã— 4ä½è»¸</strong>ã§ã‚¿ã‚¤ãƒ—åˆ†é¡ã—ã¾ã™ã€‚
          </p>
        </div>

        <div class="card">
          <div class="section-title">
            <span>ğŸ§¬ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</span>
            <span class="pill">åå‰ã”ã¨ã«å±¥æ­´ãŒåˆ†ã‹ã‚Œã¾ã™</span>
          </div>

          <div class="grid grid-cols-3" style="margin-top:.55rem;">
            <div>
              <label for="user-name">åå‰ï¼ˆå¿…é ˆï¼‰</label>
              <input id="user-name" type="text" placeholder="ä¾‹: ã“ã¾ã / K.K." />
              <div class="muted small" style="margin-top:.25rem;">â€»åŒã˜åå‰ãªã‚‰å±¥æ­´ãŒç¶šãã¾ã™ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ä¿å­˜ï¼‰</div>
            </div>
            <div>
              <label for="age-group">å¹´é½¢å±¤</label>
              <select id="age-group">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                <option value="teen">ã€œ19æ­³</option>
                <option value="20s">20ä»£</option>
                <option value="30s">30ä»£</option>
                <option value="40s">40ä»£ä»¥ä¸Š</option>
              </select>
            </div>
            <div>
              <label for="chronotype">ç”Ÿæ´»ãƒªã‚ºãƒ </label>
              <select id="chronotype">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                <option value="morning">æœå‹</option>
                <option value="evening">å¤œå‹</option>
                <option value="flex">ã©ã¡ã‚‰ã¨ã‚‚ã„ãˆãªã„</option>
              </select>
            </div>
          </div>

          <div style="margin-top:.75rem;">
            <label for="grade">å­¦å¹´ãƒ»è·æ¥­</label>
            <input id="grade" type="text" placeholder="ä¾‹: å¤§å­¦2å¹´ / ç¤¾ä¼šäºº3å¹´ç›®" />
          </div>
        </div>

        <div class="card">
          <div class="section-title">
            <span>ğŸ›¡ï¸ ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ã¨åŒæ„</span>
          </div>

          <div class="grid">
            <div class="toggle-row">
              <div class="toggle" id="toggle-consent" role="switch" aria-checked="false" tabindex="0">
                <div class="toggle-thumb"></div>
              </div>
              <div>
                <div>
                  ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã‚’èª­ã¿ã€<strong>åŒ¿åã®çµ±è¨ˆåˆ†æã«è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ãŒä½¿ã‚ã‚Œã‚‹ã“ã¨ã«åŒæ„</strong>ã—ã¾ã™ã€‚
                </div>
                <div class="muted small">
                  â€»ã“ã®ãƒ‡ãƒ¢ç‰ˆã§ã¯ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼‰ã®ã¿ã§å‡¦ç†ã•ã‚Œã¾ã™ã€‚
                </div>
              </div>
            </div>

            <div class="toggle-row">
              <div class="toggle" id="toggle-analytics" role="switch" aria-checked="false" tabindex="0">
                <div class="toggle-thumb"></div>
              </div>
              <div>
                <div>åŒ¿åã®åˆ©ç”¨çŠ¶æ³ï¼ˆã©ã®ç”»é¢ãŒã‚ˆãè¦‹ã‚‰ã‚ŒãŸã‹ãªã©ï¼‰ã®è¨ˆæ¸¬ã«å”åŠ›ã™ã‚‹ã€‚</div>
                <div class="muted small">å®Ÿéš›ã«ã¯å¤–éƒ¨é€ä¿¡ã›ãšã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®ON/OFFã ã‘ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚</div>
              </div>
            </div>
          </div>

          <div class="btn-row">
            <button id="start-quiz-btn" class="primary" disabled>è¨ºæ–­ã‚’å§‹ã‚ã‚‹ ğŸš€</button>
          </div>
        </div>
      </section>

      <!-- Quiz -->
      <section id="quiz-section" style="display:none;">
        <div class="card">
          <div class="quiz-header">
            <div>
              <h2>ğŸ“ Well-BTI è¨ºæ–­ãƒ†ã‚¹ãƒˆ</h2>
              <p class="muted small">ç›´è¿‘ã®ã‚ãªãŸã®çŠ¶æ…‹ã‚’æ€ã„æµ®ã‹ã¹ãªãŒã‚‰ã€ç›´æ„Ÿã§ç­”ãˆã¦ãã ã•ã„ã€‚1ã€œ5ã¯ã€Œå…¨ããã†æ€ã‚ãªã„ã€œã¨ã¦ã‚‚ãã†æ€ã†ã€ã§ã™ã€‚</p>
            </div>

            <div class="quiz-toggle">
              <span class="muted small">è¡¨ç¤º</span>
              <div class="toggle" id="toggle-page-size" role="switch" aria-checked="false" tabindex="0">
                <div class="toggle-thumb"></div>
              </div>
              <span id="page-size-label" class="small">1å•ãšã¤</span>

              <span class="muted small" style="margin-left:.5rem;">è‡ªå‹•ã§æ¬¡ã¸</span>
              <div class="toggle" id="toggle-auto-next" role="switch" aria-checked="true" tabindex="0">
                <div class="toggle-thumb"></div>
              </div>
              <span id="auto-next-label" class="small">ON</span>
            </div>
          </div>
          <div class="page-indicator" id="page-indicator"></div>
        </div>

        <div class="card" id="quiz-questions-container"></div>

        <div class="card">
          <div class="btn-row">
            <button id="prev-page-btn" class="secondary">æˆ»ã‚‹</button>
            <button id="next-page-btn" class="primary">æ¬¡ã¸ â†’</button>
          </div>
        </div>
      </section>

      <!-- Result -->
      <section id="result-section" style="display:none;">
        <div class="card">
          <h2>ğŸ¯ è¨ºæ–­çµæœ</h2>
          <p class="muted small">
            ã€Œã‚ãªãŸã¯â—¯â—¯ã‚’æœ€å¤§åŒ–ã—ã€â–³â–³ã‚’çŠ ç‰²ã«ã—ã¦ã„ã¾ã™ã€ã‚’ä¸€æ’ƒã§å‡ºã—ã¾ã™ã€‚<br/>
            ã•ã‚‰ã« <strong>é—‡è½ã¡ç‰ˆ / è¦šé†’ç‰ˆ</strong> ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã€æœªæ¥ã®åˆ†å²ã‚‚è¦‹ãˆã¾ã™ã€‚
          </p>
        </div>

        <div class="result-main">
          <div class="card">
            <div id="result-type-block"></div>

            <div class="mode-row">
              <button id="mode-awake" class="mode-btn active" type="button">âœ¨ è¦šé†’ç‰ˆ</button>
              <button id="mode-dark" class="mode-btn" type="button">ğŸŒ‘ é—‡è½ã¡ç‰ˆ</button>
            </div>

            <div class="mt-2">
              <div class="pill" id="tradeoff-line" style="display:inline-flex;"></div>
            </div>

            <div id="shortest-move-box" class="shortest-move" style="display:none;"></div>

            <div class="mt-2">
              <h3 class="small">ğŸ§  åˆ†å²ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
              <div id="mode-description" class="muted"></div>
            </div>

            <div class="mt-2">
              <h3 class="small">ğŸ” 4è»¸ã‚¹ã‚³ã‚¢</h3>
              <div id="result-scores-block" class="small" style="margin-top:.25rem;"></div>
            </div>

            <div class="mt-2">
              <h3 class="small">ğŸŒ± ä»Šé€±ã®ãƒã‚¤ã‚¯ãƒ­ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆä¸‹ä½2è»¸ã‚’åº•ä¸Šã’ï¼‰</h3>
              <ul id="result-actions-block" class="actions-list"></ul>
            </div>

            <div class="share-row">
              <input id="share-text" class="share-input" readonly />
              <button id="copy-share-btn" class="secondary" type="button">ã‚³ãƒ”ãƒ¼ ğŸ“‹</button>
              <button id="native-share-btn" class="secondary" type="button">å…±æœ‰ ğŸ“¤</button>
            </div>
          </div>

          <div class="card">
            <h3 class="small">ğŸ“Š ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ</h3>
            <canvas id="radar-canvas" width="420" height="420" aria-label="Well-Beingãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ"></canvas>

            <div class="mt-2">
              <h3 class="small">ğŸ•˜ éå»ã®çµæœã‚’å†è¡¨ç¤º</h3>
              <p class="muted small">å±¥æ­´ã‹ã‚‰ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®å›ã®ã‚¹ã‚³ã‚¢ã§ã“ã®çµæœç”»é¢ãŒæ›´æ–°ã•ã‚Œã¾ã™ã€‚</p>
              <button id="jump-history-btn" class="ghost" type="button">å±¥æ­´ã¸è¡Œã â†’</button>
            </div>
          </div>
        </div>
      </section>

      <!-- History -->
      <section id="history-section" style="display:none;">
        <div class="card">
          <h2>ğŸ“ˆ ã‚ãªãŸã®Well-Beingãƒˆãƒ¬ãƒ³ãƒ‰</h2>
          <p class="muted small">åå‰ã”ã¨ã«å±¥æ­´ãŒä¿å­˜ã•ã‚Œã¾ã™ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ï¼‰ã€‚åˆ¥ã®åå‰ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã¨ã€ãã®äººã®å±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
        </div>

        <div class="card">
          <div class="section-title">
            <span>ğŸ‘¤ å±¥æ­´ã‚’è¦‹ã‚‹åå‰</span>
          </div>
          <div class="grid" style="grid-template-columns: 1fr auto; align-items:end;">
            <div>
              <label for="history-user-select">åå‰ã‚’é¸æŠ</label>
              <select id="history-user-select"></select>
              <div class="muted small" style="margin-top:.25rem;">â€»ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹åå‰ã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™</div>
            </div>
            <div>
              <button id="set-as-current-user-btn" class="secondary" type="button">ã“ã®åå‰ã‚’ç¾åœ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã™ã‚‹</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h3 class="small">ãƒ©ã‚¤ãƒ³ãƒãƒ£ãƒ¼ãƒˆ</h3>
          <canvas id="history-canvas" width="760" height="280" aria-label="å±¥æ­´ã®æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•"></canvas>
          <div class="mt-2">
            <span class="badge-chip" style="border-color:rgba(22,163,74,.35);color:var(--h-color);">H:æ´»åŠ›</span>
            <span class="badge-chip" style="border-color:rgba(202,138,4,.35);color:var(--e-color);">E:è²¡å‹™çš„å®‰å¿ƒ</span>
            <span class="badge-chip" style="border-color:rgba(37,99,235,.35);color:var(--s-color);">S:æ‰€å±</span>
            <span class="badge-chip" style="border-color:rgba(219,39,119,.35);color:var(--r-color);">R:ç›®çš„</span>
          </div>
        </div>

        <div class="card">
          <h3 class="small">å±¥æ­´ä¸€è¦§ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ãã®å›ã‚’å†è¡¨ç¤ºï¼‰</h3>
          <div id="history-list-container" class="history-list"></div>
          <div class="mt-2">
            <span id="clear-history-btn" class="danger-link">ã“ã®åå‰ã®å±¥æ­´ã‚’å‰Šé™¤ã™ã‚‹ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼‰</span>
          </div>
        </div>
      </section>

      <p class="muted small" style="margin-top:1rem;">
        â€»ã“ã®ãƒ‡ãƒ¢ã¯ãƒ­ãƒ¼ã‚«ãƒ«å®Œçµã§ã™ã€‚å…¥åŠ›ãƒ»çµæœã¯ã‚ãªãŸã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼ˆlocalStorageï¼‰ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚
      </p>
    </div>
  </main>
</div>

<script>
/******************************************************************
 * ãƒ‡ãƒ¼ã‚¿å®šç¾©
 ******************************************************************/
const AXES = ["H","E","S","R"];
const AXIS_LABELS = {
  H:"H: æ´»åŠ›ï¼ˆå¥åº·ãƒ»å®‰å®šï¼‰",
  E:"E: è²¡å‹™çš„å®‰å¿ƒ",
  S:"S: æ‰€å±ãƒ»ã¤ãªãŒã‚Š",
  R:"R: ç›®çš„ãƒ»è‡ªå·±å®Ÿç¾"
};
const AXIS_CORE = { H:"å¥åº·ã¨å›å¾©", E:"çµŒæ¸ˆçš„å®‰å®š", S:"ã¤ãªãŒã‚Š", R:"ç›®çš„ã¨æ„å‘³" };
const AXIS_EMOJI = { H:"ğŸ’ª", E:"ğŸ’°", S:"ğŸ¤", R:"ğŸš€" };
const AXIS_COLORS = {
  H: getComputedStyle(document.documentElement).getPropertyValue("--h-color") || "#16a34a",
  E: getComputedStyle(document.documentElement).getPropertyValue("--e-color") || "#ca8a04",
  S: getComputedStyle(document.documentElement).getPropertyValue("--s-color") || "#2563eb",
  R: getComputedStyle(document.documentElement).getPropertyValue("--r-color") || "#db2777"
};

// åŸºæœ¬16å•
const baseQuestions = [
  {id:"H1",axis:"H",kind:"base",reverse:false,text:"ã“ã®ä¸€é€±é–“ã§ã€ç¿Œæ—¥ã«ç–²åŠ´ã‚’æŒã¡è¶Šã•ãªã„ã¨æ„Ÿã˜ã‚‹è³ªã®é«˜ã„ç¡çœ ã‚’å–ã‚ŒãŸæ—¥ãŒã»ã¨ã‚“ã©ã ã£ãŸã€‚"},
  {id:"H2",axis:"H",kind:"base",reverse:false,text:"ã‚¹ãƒˆãƒ¬ã‚¹ã‚’æ„Ÿã˜ãŸã¨ãã€ãã‚Œã‚’é©åˆ‡ã«è§£æ¶ˆã™ã‚‹æ–¹æ³•ã‚’æŒã£ã¦ã„ã‚‹ã€‚"},
  {id:"H3",axis:"H",kind:"base",reverse:false,text:"é€±ã«2å›ä»¥ä¸Šã€å¿ƒæ‹æ•°ãŒä¸ŠãŒã‚‹ã‚ˆã†ãªé‹å‹•ã‚’æ„è­˜çš„ã«è¡Œã£ã¦ã„ã‚‹ã€‚"},
  {id:"H4",axis:"H",kind:"base",reverse:false,text:"çªç„¶ã®ãƒã‚¬ãƒ†ã‚£ãƒ–ãªå‡ºæ¥äº‹ãŒã‚ã£ã¦ã‚‚ã€æ„Ÿæƒ…çš„ã«ãƒ‘ãƒ‹ãƒƒã‚¯ã«ãªã‚‹ã“ã¨ã¯å°‘ãªã„ã€‚"},
  {id:"E1",axis:"E",kind:"base",reverse:false,text:"äºˆæœŸã›ã¬å¤§ããªå‡ºè²»ã«å¯¾å¿œã§ãã‚‹è²¯è“„ãŒã‚ã‚‹ã€‚"},
  {id:"E2",axis:"E",kind:"base",reverse:false,text:"æ¯æœˆã®äºˆç®—ã‚’äº‹å‰ã«æ±ºã‚ã¦ãŠã‚Šã€ãã‚Œã‚’ã»ã¨ã‚“ã©å®ˆã‚Œã¦ã„ã‚‹ã€‚"},
  {id:"E3",axis:"E",kind:"base",reverse:false,text:"å°†æ¥ã®è²¡å‹™çŠ¶æ³ã«ã¤ã„ã¦ã€å…·ä½“çš„ãªè¨ˆç”»ã‚’æŒã£ã¦ã„ã‚‹ã€‚"},
  {id:"E4",axis:"E",kind:"base",reverse:false,text:"çµŒæ¸ˆçš„ç†ç”±ã§ã€ã‚„ã‚ŠãŸã„ã“ã¨ã‚„å­¦ã³ã‚’è«¦ã‚ã¦ã„ã‚‹ã¨æ„Ÿã˜ã‚‹ã“ã¨ã¯ã»ã¨ã‚“ã©ãªã„ã€‚"},
  {id:"S1",axis:"S",kind:"base",reverse:false,text:"å¼±ã¿ã‚„æ‚©ã¿ã‚’éš ã•ãšã«è©±ã›ã‚‹è¦ªã—ã„å‹äººãŒ2äººä»¥ä¸Šã„ã‚‹ã€‚"},
  {id:"S2",axis:"S",kind:"base",reverse:false,text:"æ‰€å±ã™ã‚‹ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã§ã€è‡ªåˆ†ãŒå¿…è¦ã¨ã•ã‚Œã¦ã„ã‚‹ã¨æ„Ÿã˜ã‚‹ã€‚"},
  {id:"S3",axis:"S",kind:"base",reverse:false,text:"æœ€è¿‘ã®äººé–“é–¢ä¿‚ã¯ã€æ¶ˆè€—ã§ã¯ãªãæ´»åŠ›ã‚’ä¸ãˆã¦ãã‚Œã‚‹ã€‚"},
  {id:"S4",axis:"S",kind:"base",reverse:false,text:"èª°ã¨ã‚‚è©±ã•ãªã„æ—¥ãŒã‚ã£ã¦ã‚‚ã€å­¤ç«‹ã—ã¦ã„ã‚‹æ„Ÿè¦šã¯ã»ã¨ã‚“ã©ãªã„ã€‚"},
  {id:"R1",axis:"R",kind:"base",reverse:false,text:"äººç”Ÿã«ã¯æ˜ç¢ºãªç›®æ¨™ã‚„ä½¿å‘½ãŒã‚ã‚Šã€ãã®ãŸã‚ã«è¡Œå‹•ã§ãã¦ã„ã‚‹ã€‚"},
  {id:"R2",axis:"R",kind:"base",reverse:false,text:"æ–°ã—ã„çŸ¥è­˜ã‚„ã‚¹ã‚­ãƒ«ã‚’å­¦ã¶ã“ã¨ã«ã€æ™‚é–“ã‚„ãŠé‡‘ã‚’æŠ•è³‡ã—ã¦ã„ã‚‹ã€‚"},
  {id:"R3",axis:"R",kind:"base",reverse:false,text:"æ™‚é–“ãŒã‚ã£ã¨ã„ã†é–“ã«éãã‚‹ã»ã©ã€ç†±ä¸­ã§ãã‚‹æ´»å‹•ã‚’é€±ã«æ•°å›è¡Œã£ã¦ã„ã‚‹ã€‚"},
  {id:"R4",axis:"R",kind:"base",reverse:false,text:"é‡è¦ãªé¸æŠã‚’ã€ä»–äººã®æ„è¦‹ã§ã¯ãªãè‡ªåˆ†ã®ä¾¡å€¤è¦³ã«åŸºã¥ã„ã¦è¡Œã£ã¦ã„ã‚‹ã€‚"},
];

// è»¸é–“æ¯”è¼ƒ 12å•ï¼ˆä¸»è»¸ vs æ¯”è¼ƒè»¸ï¼‰
const pairQuestions = [
  {id:"P_EH1",kind:"pair",axis:"E",compareAxis:"H",text:"å¯ä¸è¶³ã§å­¦æ ¡ã‚„ãƒã‚¤ãƒˆã«è¡ŒããŒã¡ã ã€‚"},
  {id:"P_ES1",kind:"pair",axis:"E",compareAxis:"S",text:"å‹é”ã¨éŠã¶ã‚ˆã‚Šã€ç¨¼ãæ–¹ãŒæº€ãŸã•ã‚Œã‚‹ã€‚"},
  {id:"P_ER1",kind:"pair",axis:"E",compareAxis:"R",text:"ç›®çš„ã®é”æˆã®ãŸã‚ãªã‚‰ãŠé‡‘ã‚’ä½¿ã†ã“ã¨ã¯å­ã‚ãªã„ã€‚"},
  {id:"P_HE1",kind:"pair",axis:"H",compareAxis:"E",text:"å¤šå°‘é«˜ãã¦ã‚‚å¥åº·çš„ãªé£Ÿäº‹ã‚’ã™ã‚‹ã€‚"},
  {id:"P_HS1",kind:"pair",axis:"H",compareAxis:"S",text:"èª˜ã„ãŒã‚ã£ã¦ã‚‚ã€å¥åº·ãŒå¤§äº‹ãªã®ã§æ–­ã‚‹ã“ã¨ãŒå¤šã„ã€‚"},
  {id:"P_HR1",kind:"pair",axis:"H",compareAxis:"R",text:"è©¦é¨“å‰ã§ã‚‚ç¡çœ ã‚’å„ªå…ˆã™ã‚‹ã€‚"},
  {id:"P_SE1",kind:"pair",axis:"S",compareAxis:"E",text:"é‡‘éŠ­æ„Ÿè¦šãŒåˆã‚ãªãã¦ã‚‚å‹é”ä»˜ãåˆã„ã‚’å„ªå…ˆã—ã¦ã—ã¾ã†ã€‚"},
  {id:"P_SH1",kind:"pair",axis:"S",compareAxis:"H",text:"å‘¨ã‚Šã®å½±éŸ¿ã§ç”Ÿæ´»ç¿’æ…£ãŒä¹±ã‚ŒãŒã¡ã ã€‚"},
  {id:"P_SR1",kind:"pair",axis:"S",compareAxis:"R",text:"é‡è¦ãªæ±ºæ–­ã§å‘¨ã‚Šã«æ±ºã‚ã¦ã‚‚ã‚‰ã„ãŒã¡ã ã€‚"},
  {id:"P_RE1",kind:"pair",axis:"R",compareAxis:"E",text:"è‡ªåˆ†ã®å¥½ããªã‚‚ã®ã«ã¯ãŠé‡‘ã‚’æƒœã—ã¾ãªã„ã€‚"},
  {id:"P_RH1",kind:"pair",axis:"R",compareAxis:"H",text:"ç¡çœ ã‚’å‰Šã£ã¦ã§ã‚‚æˆé•·ã«ã¤ãªãŒã‚‹ã“ã¨ã‚’å„ªå…ˆã—ãŸã„ã€‚"},
  {id:"P_RS1",kind:"pair",axis:"R",compareAxis:"S",text:"ç›®çš„ã®ãŸã‚ãªã‚‰å­¤ç«‹ã—ã¦ã‚‚ã„ã„ã¨æ€ã†ã€‚"},
];

const QUESTIONS = [...baseQuestions, ...pairQuestions];

// ãƒšã‚¢è³ªå•ã®å¯„ä¸ï¼ˆ1ã€œ5ï¼‰
const pairScoreMap = {
  1:{main:-20, comp:+20},
  2:{main:-10, comp:+10},
  3:{main:  0, comp:  0},
  4:{main:+10, comp:-10},
  5:{main:+20, comp:-20},
};

// 1ä½è»¸ Ã— 4ä½è»¸ï¼ˆTOP-LOWï¼‰
const TYPE_TABLE = {
  "E-H":{code:"E-H",label:"ç¤¾ç•œ",vibe:"ç¨¼ãå„ªå…ˆã§ä½“ãŒå¾Œå›ã—",dark:"æ…¢æ€§ç–²åŠ´ã§æˆæœãŒè½ã¡ã‚‹ã®ã«ã€ã•ã‚‰ã«åŠ´åƒã§åŸ‹ã‚ã‚‹ãƒ«ãƒ¼ãƒ—ã«å…¥ã‚‹ã€‚",awake:"ç¡çœ ãƒ»å›å¾©ã‚’â€œæŠ•è³‡â€æ‰±ã„ã«ã—ã¦ã€åŒã˜åŠªåŠ›ã§æˆæœã‚’å€ã«ã™ã‚‹ã€‚"},
  "E-S":{code:"E-S",label:"ã‚³ã‚¹ãƒ‘åŸç†ä¸»ç¾©è€…",vibe:"æå¾—æœ€é©åŒ–ã§å­¤ç«‹ã—ãŒã¡",dark:"æ­£è«–ã¨åˆç†æ€§ã ã‘ãŒæ®‹ã‚Šã€åŠ©ã‘ãŒæ¥ãªã„â€œå­¤ç‹¬ãªæœ€é©åŒ–â€ã«ãªã‚‹ã€‚",awake:"äººé–“é–¢ä¿‚ã‚’â€œéåŠ¹ç‡ã ã‘ã©å¼·ã„è³‡ç”£â€ã¨ã—ã¦è¨­è¨ˆã—ã€å‘³æ–¹ã‚’å¢—ã‚„ã™ã€‚"},
  "E-R":{code:"E-R",label:"é‡‘ã®äº¡è€…",vibe:"é‡‘ãŒç›®çš„ã‚’é£²ã¿è¾¼ã‚€",dark:"å¢—ãˆã‚‹æ®‹é«˜ã€æ¸›ã‚‹ç´å¾—æ„Ÿã€‚å‹ã£ã¦ã‚‹ã®ã«è™šã—ã„çŠ¶æ…‹ã¸ã€‚",awake:"ãŠé‡‘ã‚’æ‰‹æ®µã«æˆ»ã—ã€â€œä½•ã®ãŸã‚ã«ç¨¼ãã‹â€ã§åˆ¤æ–­ãŒé€Ÿããªã‚‹ã€‚"},
  "H-E":{code:"H-E",label:"ã‚¢ã‚¹ãƒªãƒ¼ãƒˆ",vibe:"æ•´ãˆã‚‹ãŒé‡‘ã¯å¾Œå›ã—",dark:"ä¸‡å…¨ã‚’å¾…ã¡ã™ãã¦æ©Ÿä¼šã‚’é€ƒã™ã€‚æº–å‚™ã ã‘ã§å¹´ãŒçµ‚ã‚ã‚‹ã€‚",awake:"å¥åº·Ã—åå…¥ã®ä¸¡ç«‹ã§é•·æœŸå‹ã¡ã€‚ä½“èª¿ã‚’å®ˆã‚ŠãªãŒã‚‰ç¨¼ããƒ«ãƒ¼ãƒ«ã‚’ä½œã‚Œã‚‹ã€‚"},
  "H-S":{code:"H-S",label:"ä»™äºº",vibe:"å¹³ç©é‡è¦–ã§é–¢ä¿‚ãŒè–„ããªã‚‹",dark:"æ³¢é¢¨ã‚¼ãƒ­ã ãŒå­¤ç«‹ãŒé€²ã‚€ã€‚â€œå®‰å…¨â€ãŒâ€œç„¡äººâ€ã«ãªã‚‹ã€‚",awake:"ç„¡ç†ã›ãšç¹‹ãŒã‚Œã‚‹å°ç·šã‚’ä½œã‚Šã€é™ã‹ãªä¿¡é ¼ã®ãƒãƒ–ã«ãªã‚Œã‚‹ã€‚"},
  "H-R":{code:"H-R",label:"è„³ç­‹",vibe:"å‹¢ã„ã¯ã‚ã‚‹ãŒç›®çš„ãŒéœã‚€",dark:"å…¨åŠ›ãªã®ã«æ–¹å‘ãŒã‚ºãƒ¬ã‚‹ã€‚ç‡ƒãˆå°½ãã¨å¾’åŠ´ã®ã‚»ãƒƒãƒˆã€‚",awake:"ä½“åŠ›ã‚’â€œç›®çš„é”æˆã®ç‡ƒæ–™â€ã«ã§ãã‚‹ã€‚ã‚„ã‚‹ã“ã¨ã®é¸çƒçœ¼ãŒç”Ÿã¾ã‚Œã‚‹ã€‚"},
  "S-E":{code:"S-E",label:"äººæƒ…ç ´ç”£äºˆå‚™è»",vibe:"å„ªã—ã•ã§è²¡å¸ƒãŒæ­»ã¬",dark:"æ°—å‰è‰¯ã•ãŒç¾©å‹™åŒ–ã—ã¦ã€ä½™è£•ãŒæ¶ˆãˆã‚‹ã€‚å„ªã—ã•ãŒè‹¦ã—ããªã‚‹ã€‚",awake:"å‡ºã™ç¯„å›²ã‚’æ±ºã‚ã¦â€œæŒç¶šå¯èƒ½ãªå„ªã—ã•â€ã‚’å®Ÿè£…ã§ãã‚‹ã€‚"},
  "S-H":{code:"S-H",label:"äºŒæ—¥é…”ã„ãƒ‹ã‚­",vibe:"ãƒãƒªå„ªå…ˆã§ä½“ãŒå´©ã‚Œã‚‹",dark:"ç››ã‚Šä¸Šã’å½¹ã®ä»£å„Ÿã§æ…¢æ€§ä¸èª¿ã€‚å›å¾©ãŒè¿½ã„ã¤ã‹ãªã„ã€‚",awake:"å›å¾©ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ä»˜ãã§éŠã¹ã‚‹ã€‚â€œæ¥½ã—ã•â€ãŒé•·æŒã¡ã™ã‚‹ã€‚"},
  "S-R":{code:"S-R",label:"ç©ºæ°—äººé–“",vibe:"èª¿å’Œå„ªå…ˆã§ç›®çš„ãŒæ¶ˆãˆã‚‹",dark:"å…±æ„Ÿã®é”äººã ãŒã€äººç”Ÿã®ãƒãƒ³ãƒ‰ãƒ«ã‚’æ¡ã£ã¦ãªã„çŠ¶æ…‹ã«ãªã‚‹ã€‚",awake:"â€œè‡ªåˆ†ã®è¨€è‘‰â€ã‚’æŒã£ãŸå…±æ„Ÿè€…ã€‚å‘¨ã‚Šã‚‚è‡ªåˆ†ã‚‚æ•‘ãˆã‚‹ã€‚"},
  "R-E":{code:"R-E",label:"ç†æƒ³è¿½æ±‚äº¡è€…",vibe:"ç†æƒ³ã®ãŸã‚ã«ç¾å®ŸãŒå´©ã‚Œã‚‹",dark:"å¿—ã¯é«˜ã„ã®ã«è³‡é‡‘ãŒç¶šã‹ãªã„ã€‚å¤¢ãŒâ€œæ¯åˆ‡ã‚Œâ€ã§çµ‚ã‚ã‚‹ã€‚",awake:"ç†æƒ³ã‚’å›ã™ç¾å®Ÿè¨­è¨ˆè€…ã€‚ç›®çš„ã¨è³‡é‡‘è¨ˆç”»ãŒå™›ã¿åˆã†ã€‚"},
  "R-H":{code:"R-H",label:"è‡ªå£Šå‹é©å‘½å®¶",vibe:"ä½¿å‘½ã§è‡ªåˆ†ã‚’å‰Šã‚‹",dark:"ç‡ƒãˆå°½ãè‹±é›„ã€‚å£Šã‚Œã¦ã‹ã‚‰ã‚„ã£ã¨æ­¢ã¾ã‚‹ã€‚",awake:"ä¼‘ã‚€ã®ã‚‚æˆ¦ç•¥ã€‚å›å¾©ã‚’å…¥ã‚Œã¦ã“ãé©å‘½ãŒç¶šãã€‚"},
  "R-S":{code:"R-S",label:"å­¤é«˜ã®æš´å›",vibe:"ç›®çš„å„ªå…ˆã§å­¤ç«‹ã™ã‚‹",dark:"æˆæœã¯å‡ºã‚‹ãŒå‘³æ–¹ãŒã„ãªã„ã€‚ã„ã¤ã‹æŠ˜ã‚Œã‚‹ã€‚",awake:"ãƒ“ã‚¸ãƒ§ãƒ³ã‚’å…±æœ‰ã§ãã‚‹ç‹ã€‚å”åŠ›ã‚’å¼•ãå‡ºã—ã€ã‚‚ã£ã¨é ãã¸è¡Œã‘ã‚‹ã€‚"},
};

// 4è»¸å®Œå…¨åŒç‚¹ã®ç‰¹æ®Šã‚¿ã‚¤ãƒ—ï¼ˆã‚¹ã‚³ã‚¢å¸¯åˆ¥ï¼‰
const TIE_TYPES = {
  "0":   { label:"è™šç„¡",  dark:"å…¨éƒ¨ã‚¼ãƒ­ã€‚æ„Ÿæƒ…ã‚‚ä½“åŠ›ã‚‚è²¡å¸ƒã‚‚ç›®çš„ã‚‚ã€ã„ã£ãŸã‚“åœæ­¢ã—ã¦ã‚‹ã€‚", awake:"ã¾ãšã¯â€œä»Šæ—¥ã®æœ€ä½ãƒ©ã‚¤ãƒ³â€ã‚’ä½œã‚‹ã ã‘ã§ååˆ†ã€‚", hint:"ã‚„ã‚‹ã“ã¨ã¯1ã¤ã ã‘ã€‚ç¡çœ â†’é£Ÿäº‹â†’å¤–ã«å‡ºã‚‹ã€ã®é †ã§å¾©å¸°ã€‚" },
  "low": { label:"è¿·å­",  dark:"å¤§äº‹ãªã‚‚ã®ãŒå¤šã™ãã¦ã€å„ªå…ˆé †ä½ãŒæ±ºã‚ã‚‰ã‚Œãªã„ã€‚æ°¸é ã®æº–å‚™ä¸­ã€‚", awake:"ä»ŠæœŸãƒ†ãƒ¼ãƒã‚’1ã¤æ±ºã‚ãŸç¬é–“ã€å…¨éƒ¨ãŒå‹•ãå‡ºã™ã€‚", hint:"ä»Šæœˆã ã‘ã€1è»¸ã‚’â€œæœ€å„ªå…ˆâ€ã«ã™ã‚‹å®£è¨€ã‚’ã—ã‚ˆã†ã€‚" },
  "mid": { label:"è³¢è€…",  dark:"ä½•ã§ã‚‚ã§ãã‚‹ãŒã€çªå‡ºãŒãªã„ã€‚å®‰å…¨é‹è»¢ã§ä¼¸ã³ãŒéˆã‚‹ã€‚", awake:"çŠ¶æ³ã«å¿œã˜ã¦åˆ‡æ›¿ã§ãã‚‹ä¸‡èƒ½å‹ã€‚é¸ã‚“ã§å°–ã‚Œã°å¼·ã„ã€‚", hint:"ä»Šé€±ã¯â€œ1ç•ªä¼¸ã°ã—ãŸã„è»¸â€ã‚’1ã¤ã ã‘æ±ºã‚ã‚‹ã€‚" },
  "100": { label:"è–äºº",  dark:"ç†è«–ä¸Šæœ€å¼·ã ãŒã€ç¾å®Ÿã ã¨ç„¡ç†ã—ã™ãã¦åå‹•ãŒæ¥ã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚", awake:"è‡ªåˆ†ã‚‚å‘¨ã‚Šã‚‚æº€ãŸã›ã‚‹ã€‚ç¶­æŒã®ãŸã‚ã®ä¼‘æ¯ãŒéµã€‚", hint:"ç¶­æŒãŒæœ€é›£é–¢ã€‚å›å¾©æ—¥ã‚’å…ˆã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¸ã€‚" },
};

const ACTIONS = {
  H:[
    "å¯ã‚‹90åˆ†å‰ã«â€œé¢¨å‘‚ or ã‚·ãƒ£ãƒ¯ãƒ¼â€ã ã‘å›ºå®šã—ã¦ã€ç¡çœ ã®è³ªã‚’åº•ä¸Šã’ã™ã‚‹ã€‚",
    "ä»Šæ—¥ã ã‘ã§ã„ã„ã®ã§ã€æ­©ãæ™‚é–“ã‚’åˆè¨ˆ15åˆ†ã¤ãã‚‹ï¼ˆé§…1ã¤åˆ†ã§ã‚‚OKï¼‰ã€‚",
    "ã‚«ãƒ•ã‚§ã‚¤ãƒ³ã¯â€œ14æ™‚ã¾ã§â€ãƒ«ãƒ¼ãƒ«ã«ã—ã¦ã€å¤œã®å›å¾©ã‚’å®ˆã‚‹ã€‚",
    "5åˆ†ã‚¹ãƒˆãƒ¬ãƒƒãƒï¼‹æ·±å‘¼å¸ã‚’â€œãƒˆã‚¤ãƒ¬ã®å¾Œâ€ã«ç´ã¥ã‘ã¦ç¿’æ…£åŒ–ã™ã‚‹ã€‚",
    "å¯èµ·ãã«ã‚³ãƒƒãƒ—1æ¯ã®æ°´â†’ä½“ãŒç›®è¦šã‚ã‚‹å„€å¼ã«ã™ã‚‹ã€‚",
    "æ˜æ—¥ã®è‡ªåˆ†ã®ãŸã‚ã«ã€æœºã®ä¸Šã‚’30ç§’ã ã‘ç‰‡ä»˜ã‘ã‚‹ï¼ˆè„³ã®è² è·ãŒä¸‹ãŒã‚‹ï¼‰ã€‚",
    "ä»Šé€±ã¯â€œä¼‘ã‚€æ—¥â€ã‚’1å›ã ã‘å…ˆã«å®£è¨€ã—ã¦å®ˆã‚‹ã€‚",
    "ç¡çœ æ™‚é–“ã‚’å¢—ã‚„ã›ãªã„ãªã‚‰â€œèµ·åºŠæ™‚åˆ»ã ã‘å›ºå®šâ€ã—ã¦ãƒªã‚ºãƒ ã‚’ä½œã‚‹ã€‚",
  ],
  E:[
    "å›ºå®šè²»ï¼ˆã‚µãƒ–ã‚¹ã‚¯/é€šä¿¡è²»ï¼‰ã‚’1ã¤ã ã‘æ£šå¸ã—ã—ã¦ã€è§£ç´„å€™è£œã‚’å‡ºã™ã€‚",
    "ä»Šé€±ã®æ”¯å‡ºã‚’1å›ã ã‘è¦‹è¿”ã—ã¦ã€Œã„ã‚‰ãªã‹ã£ãŸæ”¯å‡ºã€ã‚’1ã¤åˆ‡ã‚‹ã€‚",
    "â€œä½¿ã£ã¦ã„ã„å¨¯æ¥½è²»â€ã‚’å…ˆã«æ±ºã‚ã¦ã€ç½ªæ‚ªæ„Ÿã‚’æ¶ˆã™ã€‚",
    "æ¥æœˆç”¨ã«500å††ã ã‘â€œé˜²ç½è²¯é‡‘â€ã‚’ä½œã£ã¦ã€å®‰å¿ƒã‚’è²·ã†ã€‚",
    "çµ¦æ–™æ—¥/å…¥é‡‘æ—¥ã«è‡ªå‹•ã§ç©ç«‹ãŒå‹•ãä»•çµ„ã¿ã‚’ä½œã‚‹ï¼ˆå°‘é¡ã§OKï¼‰ã€‚",
    "ã‚³ãƒ³ãƒ“ãƒ‹ã‚’1å›ã ã‘ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã€ãã®åˆ†ã‚’è²¯é‡‘ã«ç§»ã™ã€‚",
    "å¤§ãã„è²·ã„ç‰©ã¯â€œ24æ™‚é–“ãƒ«ãƒ¼ãƒ«â€ã‚’å°å…¥ã™ã‚‹ï¼ˆè¡å‹•ã‚’æ¶ˆã™ï¼‰ã€‚",
    "å°†æ¥ä¸å®‰ã®æ­£ä½“ã‚’1è¡Œã§æ›¸ãå‡ºã™ï¼ˆæ¼ ç„¶â†’å…·ä½“ã§ä¸å®‰ãŒæ¸›ã‚‹ï¼‰ã€‚",
  ],
  S:[
    "æœ€è¿‘é€£çµ¡ã—ã¦ãªã„äººã«â€œã‚¹ã‚¿ãƒ³ãƒ—ã ã‘â€é€ã‚‹ï¼ˆé‡ã•ã‚¼ãƒ­ï¼‰ã€‚",
    "ä»Šæ—¥ã ã‘ã§ã„ã„ã®ã§ã€Œã‚ã‚ŠãŒã¨ã†ã€ã‚’3å›è¨€ã†ã€‚",
    "5åˆ†ã ã‘é›‘è«‡ã§ãã‚‹ç›¸æ‰‹ã«â€œçŸ­æ–‡â€ã§é€£çµ¡ã™ã‚‹ï¼ˆè¿‘æ³å…±æœ‰ï¼‰ã€‚",
    "å®‰å¿ƒã§ãã‚‹å ´æ‰€ï¼ˆäºº/åº—/ã‚³ãƒŸãƒ¥ï¼‰ã‚’1ã¤ãƒ¡ãƒ¢ã—ã¦â€œé¿é›£å…ˆâ€ã‚’ä½œã‚‹ã€‚",
    "èª˜ã„ã‚’å—ã‘ã‚‹ãªã‚‰â€œæ™‚é–“ã‚’çŸ­ãâ€ã—ã¦å‚åŠ ãƒãƒ¼ãƒ‰ãƒ«ã‚’ä¸‹ã’ã‚‹ï¼ˆ30åˆ†ã§ã‚‚OKï¼‰ã€‚",
    "è‡ªåˆ†ã®è¿‘æ³ã‚’â€œ1ã¤ã ã‘â€é–‹ç¤ºã™ã‚‹ï¼ˆä¿¡é ¼ãŒè‚²ã¤ï¼‰ã€‚",
    "è‹¦æ‰‹ãªäººã¨ã¯è·é›¢ã‚’å–ã‚Šã€å¥½ããªäººã«æ™‚é–“ã‚’å¯„ã›ã‚‹ï¼ˆé–¢ä¿‚ã®æ–­æ¨é›¢ï¼‰ã€‚",
    "ä»Šé€±1å›ã ã‘ã€èª°ã‹ã«å°ã•ãæ‰‹ä¼ã£ã¦ã‚‚ã‚‰ã†ï¼ˆé ¼ã‚‹ç·´ç¿’ï¼‰ã€‚",
  ],
  R:[
    "ã‚„ã‚ŠãŸã„ã“ã¨ã‚’1ã¤é¸ã‚“ã§ã€ä»Šæ—¥ã®ã†ã¡ã«â€œæœ€åˆã®5åˆ†â€ã ã‘ã‚„ã‚‹ã€‚",
    "ã€ãªãœãã‚Œã‚’ã‚„ã‚‹ï¼Ÿã€ã‚’3è¡Œã§æ›¸ãï¼ˆç›®çš„ãŒå¼·ããªã‚‹ï¼‰ã€‚",
    "å¯ã‚‹å‰ã«ã€ä»Šæ—¥ã€æœªæ¥ã«1mmé€²ã‚“ã ã“ã¨ã€ã‚’1ã¤æ›¸ãã€‚",
    "ä»Šé€±ã®â€œã‚„ã‚‰ãªã„ã“ã¨â€ã‚’1ã¤æ±ºã‚ã‚‹ï¼ˆé›†ä¸­ãŒç”Ÿã¾ã‚Œã‚‹ï¼‰ã€‚",
    "1æ—¥ã®ã†ã¡â€œæœ€ã‚‚é ­ãŒå†´ãˆã‚‹30åˆ†â€ã‚’ç›®çš„ã‚¿ã‚¹ã‚¯ã«å›ºå®šã™ã‚‹ã€‚",
    "æ°—ã«ãªã‚‹åˆ†é‡ã®å‹•ç”»/è¨˜äº‹ã‚’1æœ¬è¦‹ãŸã‚‰ã€è¦ç‚¹ã‚’1è¡Œã ã‘ãƒ¡ãƒ¢ã™ã‚‹ã€‚",
    "ç›®æ¨™ãŒå¤§ãã„ãªã‚‰â€œä»Šé€±ã®å‹ã¡ç­‹â€ã ã‘æ±ºã‚ã‚‹ï¼ˆå°ã•ãåˆ‡ã‚‹ï¼‰ã€‚",
    "èª°ã‹ã«å®£è¨€ã™ã‚‹ï¼ˆSNS/å‹äººï¼‰â†’é€ƒã’é“ã‚’æ¸›ã‚‰ã™ã€‚",
  ],
};

// âœ… â€œé—‡è½ã¡ã‚’æ­¢ã‚ã‚‹æœ€çŸ­ã®1æ‰‹â€ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆè»¸åˆ¥ï¼‰
const SHORTEST_MOVE = {
  H: "ä»Šå¤œã ã‘ã¯<strong>å°±å¯æ™‚åˆ»ã‚’30åˆ†æ—©ã‚ã‚‹</strong>ï¼ˆå›å¾©ã®åœŸå°ã‚’å–ã‚Šæˆ»ã™ï¼‰ã€‚",
  E: "ä»Šæ—¥ã®ã†ã¡ã«<strong>å›ºå®šè²»ã‚’1ã¤ã ã‘è¦‹ç›´ã™</strong>ï¼ˆä¸å®‰ã®å‡ºã©ã“ã‚ã‚’æ–­ã¤ï¼‰ã€‚",
  S: "ä»Šã™ã<strong>1äººã«ã ã‘ã€Œå…ƒæ°—ï¼Ÿã€ã®ä¸€è¨€ã‚’é€ã‚‹</strong>ï¼ˆå­¤ç«‹ã®èŠ½ã‚’æ½°ã™ï¼‰ã€‚",
  R: "ä»Šæ—¥ã®ã†ã¡ã«<strong>ç›®çš„ã‚¿ã‚¹ã‚¯ã‚’5åˆ†ã ã‘ç€æ‰‹</strong>ï¼ˆè¿·èµ°ã‚’æ­¢ã‚ã‚‹ï¼‰ã€‚",
  TIE: "ä»Šé€±ã ã‘<strong>æœ€å„ªå…ˆã®è»¸ã‚’1ã¤å®£è¨€</strong>ï¼ˆåŒç‚¹ã®åœæ»ã‚’å´©ã™ï¼‰ã€‚",
};

/******************************************************************
 * ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
 ******************************************************************/
let analyticsEnabled = false;
let answers = {};
let pageSize = 1;
let currentIndex = 0;
let autoNext = true;
let currentMode = "awake";
let lastResult = null;

// âœ… åå‰ã¾ã‚ã‚Š
let currentUser = null; // æ­£è¦åŒ–ã—ãŸã‚­ãƒ¼
let currentUserDisplay = null; // è¡¨ç¤ºå
const CURRENT_USER_KEY = "wellbti_current_user_v1";
const USER_INDEX_KEY = "wellbti_users_v1"; // ["nameA","nameB"...] displayName
const ONBOARDING_KEY = "wellbti_onboarding_v3";

/******************************************************************
 * localStorage: åå‰â†’å±¥æ­´ã‚­ãƒ¼
 ******************************************************************/
function normalizeName(name){
  return (name||"").trim().replace(/\s+/g," ").slice(0,40);
}
function historyKeyFor(name){
  // nameã¯display
  const n = normalizeName(name);
  return `wellbti_history_v3::${n}`;
}
function loadUserIndex(){
  try{
    const raw = localStorage.getItem(USER_INDEX_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch{ return []; }
}
function saveUserIndex(names){
  localStorage.setItem(USER_INDEX_KEY, JSON.stringify(names));
}
function upsertUser(name){
  const n = normalizeName(name);
  if(!n) return;
  const list = loadUserIndex();
  if(!list.includes(n)){
    list.push(n);
    saveUserIndex(list);
  }
}
function setCurrentUser(name){
  const n = normalizeName(name);
  if(!n) return;
  currentUser = n;
  currentUserDisplay = n;
  localStorage.setItem(CURRENT_USER_KEY, n);
  upsertUser(n);
  updateCurrentUserBadge();
}
function loadCurrentUser(){
  const n = localStorage.getItem(CURRENT_USER_KEY);
  if(n && normalizeName(n)) {
    currentUser = normalizeName(n);
    currentUserDisplay = currentUser;
    return true;
  }
  return false;
}
function updateCurrentUserBadge(){
  const badge = document.getElementById("current-user-badge");
  const nameEl = document.getElementById("current-user-name");
  if(currentUserDisplay){
    badge.style.display="";
    nameEl.textContent = currentUserDisplay;
  }else{
    badge.style.display="none";
    nameEl.textContent="";
  }
}

/******************************************************************
 * ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 ******************************************************************/
function logEvent(name, data){ if(!analyticsEnabled) return; console.log("[Analytics]", name, data||""); }
function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }
function formatDateTime(ts){
  const d = new Date(ts);
  return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
}

/******************************************************************
 * ã‚¹ã‚³ã‚¢è¨ˆç®—
 ******************************************************************/
function calculateScores(){
  const baseValues = {H:[],E:[],S:[],R:[]};
  const pairContribution = {H:0,E:0,S:0,R:0};

  QUESTIONS.forEach(q=>{
    const value = Number(answers[q.id]);
    if(!value) return;

    if(q.kind==="base"){
      let v=value;
      if(q.reverse) v=6-v;
      baseValues[q.axis].push(v);
    }else{
      const m = pairScoreMap[value] || {main:0,comp:0};
      pairContribution[q.axis]+=m.main;
      pairContribution[q.compareAxis]+=m.comp;
    }
  });

  function toScore(vals, axis){
    if(!vals.length) return 50;
    const avg = vals.reduce((s,v)=>s+v,0)/vals.length; //1..5
    const baseScore = ((avg-1)/4)*100; //0..100
    const finalScore = clamp(baseScore + (pairContribution[axis]||0), 0, 100);
    return Math.round(finalScore);
  }

  return { H: toScore(baseValues.H,"H"), E: toScore(baseValues.E,"E"), S: toScore(baseValues.S,"S"), R: toScore(baseValues.R,"R") };
}
function allQuestionsAnswered(){ return QUESTIONS.every(q => answers[q.id] && Number(answers[q.id])>=1); }

/******************************************************************
 * ã‚¿ã‚¤ãƒ—åˆ¤å®šï¼ˆ1ä½Ã—4ä½ï¼‰+åŒç‚¹
 ******************************************************************/
function determineType(scores){
  const entries = Object.entries(scores).sort((a,b)=>b[1]-a[1]);
  const [topAxis] = entries[0];
  const [lowAxis] = entries[entries.length-1];

  const maxV = entries[0][1];
  const minV = entries[entries.length-1][1];
  const EPS = 2;
  if(Math.abs(maxV - minV) <= EPS){
    const v = Math.round((maxV+minV)/2);
    let bucket = "mid";
    if(v===0) bucket="0";
    else if(v===100) bucket="100";
    else if(v<50) bucket="low";
    else bucket="mid";
    const t=TIE_TYPES[bucket];
    return { kind:"tie", code:`TIE-${bucket.toUpperCase()}`, label:t.label, vibe:"å…¨è»¸ãŒã»ã¼åŒã˜å¼·ã•", dark:t.dark, awake:t.awake, hint:t.hint, topAxis:null, lowAxis:null };
  }

  const key=`${topAxis}-${lowAxis}`;
  const base = TYPE_TABLE[key] || {code:key,label:"ãƒãƒ©ãƒ³ã‚¹å‹ï¼ˆä¾‹å¤–ï¼‰",vibe:"ä¾‹å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³",dark:"åã‚Šã¯è–„ã„ãŒã€å„ªå…ˆé †ä½ãŒæ›–æ˜§ã ã¨ç–²ã‚Œã‚‹ã€‚",awake:"çŠ¶æ³ã«å¿œã˜ã¦ä½¿ã„åˆ†ã‘ã‚‰ã‚Œã‚‹ã€‚è»¸ã‚’æ„è­˜ã™ã‚‹ã¨ä¼¸ã³ã‚‹ã€‚"};
  return { kind:"pair", code:base.code, label:base.label, vibe:base.vibe, dark:base.dark, awake:base.awake, topAxis, lowAxis };
}

/******************************************************************
 * ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆä¸‹ä½2è»¸ç‹™ã„ï¼‰
 ******************************************************************/
function getActions(scores){
  const entries = Object.entries(scores).sort((a,b)=>a[1]-b[1]);
  const lowAxes = entries.slice(0,2).map(([k])=>k);

  const out=[]; const seen=new Set();
  function pushAxis(axis,n){
    const arr=ACTIONS[axis]||[];
    for(const a of arr){
      const line=`${AXIS_EMOJI[axis]} ${a}`;
      if(!seen.has(line)){ out.push(line); seen.add(line); }
      if(out.length>=n) return;
    }
  }
  lowAxes.forEach(ax=>{ const before=out.length; pushAxis(ax, before+3); });
  if(out.length<6){ AXES.forEach(ax=>{ if(out.length<6) pushAxis(ax, out.length+1); }); }
  return out.slice(0,6);
}

/******************************************************************
 * 1è¡Œãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•
 ******************************************************************/
function makeTradeoffLine(typeInfo){
  if(typeInfo.kind==="tie"){
    return `ã‚ãªãŸã¯â€œã©ã®è»¸ã‚‚åŒã˜å¼·ã•â€ã§ã™ï¼ˆ${typeInfo.label}ï¼‰ã€‚ä»Šã¯ã€Œä½•ã‚’å„ªå…ˆã™ã‚‹ã‹ã€ãŒéµã€‚`;
  }
  const top = AXIS_CORE[typeInfo.topAxis] || typeInfo.topAxis;
  const low = AXIS_CORE[typeInfo.lowAxis] || typeInfo.lowAxis;
  return `ã‚ãªãŸã¯ã€Œ${top}ã€ã‚’æœ€å¤§åŒ–ã—ã€ã€Œ${low}ã€ã‚’çŠ ç‰²ã«ã—ã¦ã„ã¾ã™ã€‚`;
}

/******************************************************************
 * âœ… é—‡è½ã¡ã‚’æ­¢ã‚ã‚‹æœ€çŸ­ã®1æ‰‹ï¼ˆå¤ªå­—1å€‹ï¼‰
 ******************************************************************/
function getShortestMove(typeInfo){
  if(typeInfo.kind==="tie"){
    return SHORTEST_MOVE.TIE;
  }
  const low = typeInfo.lowAxis;
  return SHORTEST_MOVE[low] || SHORTEST_MOVE.TIE;
}

/******************************************************************
 * ãƒ¬ãƒ¼ãƒ€ãƒ¼
 ******************************************************************/
function drawRadar(scores){
  const canvas=document.getElementById("radar-canvas");
  if(!canvas || !canvas.getContext) return;
  const ctx=canvas.getContext("2d");
  const w=canvas.width,h=canvas.height;
  ctx.clearRect(0,0,w,h);

  const cx=w/2, cy=h/2;
  const maxR=Math.min(w,h)*0.35;

  ctx.fillStyle="#fff";
  ctx.fillRect(0,0,w,h);

  ctx.strokeStyle="#e5e7eb";
  ctx.lineWidth=1;
  for(let i=1;i<=4;i++){
    const r=(maxR/4)*i;
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.stroke();
  }

  const angles={H:-Math.PI/2, E:0, S:Math.PI/2, R:Math.PI};
  ctx.font="12px system-ui";
  ctx.textAlign="center"; ctx.textBaseline="middle";

  AXES.forEach(axis=>{
    const a=angles[axis];
    const x=cx+maxR*Math.cos(a);
    const y=cy+maxR*Math.sin(a);
    ctx.strokeStyle="#e5e7eb";
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x,y); ctx.stroke();

    const lx=cx+(maxR+18)*Math.cos(a);
    const ly=cy+(maxR+18)*Math.sin(a);
    ctx.fillStyle=AXIS_COLORS[axis] || "#111827";
    ctx.fillText(`${AXIS_EMOJI[axis]} ${axis}`, lx, ly);
  });

  ctx.beginPath();
  AXES.forEach((axis,i)=>{
    const a=angles[axis];
    const r=maxR*((scores[axis]||0)/100);
    const x=cx+r*Math.cos(a), y=cy+r*Math.sin(a);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.closePath();
  ctx.fillStyle="rgba(37,99,235,.18)";
  ctx.fill();
  ctx.strokeStyle="rgba(219,39,119,.55)";
  ctx.lineWidth=2;
  ctx.stroke();
}

/******************************************************************
 * âœ… å±¥æ­´ï¼ˆåå‰ã”ã¨ï¼‰
 ******************************************************************/
function loadHistory(name){
  const n = normalizeName(name || currentUser);
  if(!n) return [];
  try{
    const raw=localStorage.getItem(historyKeyFor(n));
    if(!raw) return [];
    const arr=JSON.parse(raw);
    return Array.isArray(arr)?arr:[];
  }catch{ return []; }
}
function saveHistoryItem(item){
  if(!currentUser) return;
  const history=loadHistory(currentUser);
  history.push(item);
  localStorage.setItem(historyKeyFor(currentUser), JSON.stringify(history));
}
function clearHistoryFor(name){
  const n=normalizeName(name || currentUser);
  if(!n) return;
  localStorage.removeItem(historyKeyFor(n));
}
function renderHistoryUserSelect(selectedName){
  const sel = document.getElementById("history-user-select");
  const list = loadUserIndex();
  const current = normalizeName(selectedName || currentUser || list[0] || "");
  sel.innerHTML = (list.length ? list : [""]).map(n=>`<option value="${n}">${n || "ï¼ˆå±¥æ­´ãªã—ï¼‰"}</option>`).join("");
  if(current && list.includes(current)) sel.value = current;
}
function renderHistoryList(name){
  const container=document.getElementById("history-list-container");
  const history=loadHistory(name);
  if(!history.length){
    container.innerHTML='<div class="history-empty">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚è¨ºæ–­ã‚’ã™ã‚‹ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>';
    return;
  }
  container.innerHTML = history.map((h,idx)=>{
    const ts=formatDateTime(h.timestamp);
    const s=h.scores;
    return `
      <div class="history-item" data-idx="${idx}">
        <div>#${idx+1} <span class="muted">${ts}</span><div class="muted small">${h.typeLabel}ï¼ˆ${h.typeCode}ï¼‰</div></div>
        <div class="small" style="text-align:right;">
          H:${s.H} / E:${s.E} / S:${s.S} / R:${s.R}
        </div>
      </div>
    `;
  }).join("");

  container.querySelectorAll(".history-item").forEach(el=>{
    el.addEventListener("click", ()=>{
      const idx=Number(el.getAttribute("data-idx"));
      const history=loadHistory(getHistoryViewingUser());
      const item=history[idx];
      if(!item) return;
      const type = determineType(item.scores);
      const actions = getActions(item.scores);
      renderResult(item.scores, type, actions, {fromHistory:true, timestamp:item.timestamp});
      showSection("result-section");
      window.scrollTo({top:0, behavior:"smooth"});
    });
  });
}
function getHistoryViewingUser(){
  const sel = document.getElementById("history-user-select");
  return normalizeName(sel?.value || currentUser);
}
function drawHistoryChart(name){
  const canvas=document.getElementById("history-canvas");
  if(!canvas || !canvas.getContext) return;
  const ctx=canvas.getContext("2d");
  const w=canvas.width, h=canvas.height;
  ctx.clearRect(0,0,w,h);

  ctx.fillStyle="#ffffff";
  ctx.fillRect(0,0,w,h);

  const history=loadHistory(name);
  if(!history.length){
    ctx.fillStyle="#6b7280";
    ctx.font="12px system-ui";
    ctx.textAlign="center";
    ctx.fillText("ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚è¨ºæ–­ã™ã‚‹ã¨ã“ã“ã«æŠ˜ã‚Œç·šãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚", w/2, h/2);
    return;
  }

  const pad={l:44,r:12,t:18,b:28};
  const cw=w-pad.l-pad.r;
  const ch=h-pad.t-pad.b;
  const maxY=100, minY=0;
  const stepX = history.length>1 ? cw/(history.length-1) : 0;

  ctx.strokeStyle="#e5e7eb";
  ctx.lineWidth=1;
  ctx.beginPath();
  ctx.moveTo(pad.l,pad.t);
  ctx.lineTo(pad.l,h-pad.b);
  ctx.lineTo(w-pad.r,h-pad.b);
  ctx.stroke();

  ctx.font="10px system-ui";
  ctx.fillStyle="#6b7280";
  ctx.textAlign="right";
  [0,25,50,75,100].forEach(yVal=>{
    const y=pad.t+ch-((yVal-minY)/(maxY-minY))*ch;
    ctx.fillText(String(yVal), pad.l-6, y+3);
    ctx.strokeStyle="#f3f4f6";
    ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(w-pad.r,y); ctx.stroke();
  });

  function drawAxisLine(axis,color){
    ctx.strokeStyle=color; ctx.lineWidth=1.8;
    ctx.beginPath();
    history.forEach((it,idx)=>{
      const v=it.scores[axis];
      const x=pad.l+stepX*idx;
      const y=pad.t+ch-((v-minY)/(maxY-minY))*ch;
      if(idx===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
    history.forEach((it,idx)=>{
      const v=it.scores[axis];
      const x=pad.l+stepX*idx;
      const y=pad.t+ch-((v-minY)/(maxY-minY))*ch;
      ctx.fillStyle=color;
      ctx.beginPath(); ctx.arc(x,y,2.6,0,Math.PI*2); ctx.fill();
    });
  }

  drawAxisLine("H", AXIS_COLORS.H);
  drawAxisLine("E", AXIS_COLORS.E);
  drawAxisLine("S", AXIS_COLORS.S);
  drawAxisLine("R", AXIS_COLORS.R);

  ctx.textAlign="center";
  history.forEach((it,idx)=>{
    const x=pad.l+stepX*idx;
    ctx.fillStyle="#6b7280";
    ctx.fillText(String(idx+1), x, h-10);
  });
}

/******************************************************************
 * è³ªå•æç”»ï¼ˆè¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ« 1å•/4å•ã€è‡ªå‹•é·ç§»ï¼‰
 ******************************************************************/
function renderQuizPage(){
  const container = document.getElementById("quiz-questions-container");
  const total = QUESTIONS.length;
  const endIndex = Math.min(currentIndex + pageSize, total);
  const slice = QUESTIONS.slice(currentIndex, endIndex);

  const pageIndicator = document.getElementById("page-indicator");
  const pageNum = Math.floor(currentIndex / pageSize) + 1;
  const pageCount = Math.ceil(total / pageSize);
  pageIndicator.textContent = `ãƒšãƒ¼ã‚¸ ${pageNum} / ${pageCount}ï¼ˆå…¨ ${total} å•ï¼‰`;

  container.innerHTML = slice.map((q)=>{
    const value = answers[q.id] ? Number(answers[q.id]) : null;
    const axisTag = (q.kind==="base")
      ? `<span class="axis-tag" data-axis="${q.axis}">${AXIS_EMOJI[q.axis]} ${AXIS_LABELS[q.axis]}</span>`
      : `<span class="axis-tag" data-axis="${q.axis}">${AXIS_EMOJI[q.axis]} ä¸»è»¸: ${q.axis}</span>
         <span class="axis-tag" data-axis="${q.compareAxis}">âš– æ¯”è¼ƒè»¸: ${q.compareAxis}</span>`;

    return `
      <div class="question" data-qid="${q.id}">
        <div class="question-text">${q.text}</div>
        <div>${axisTag}</div>
        <div class="scale-row" role="radiogroup" aria-label="${q.id}">
          ${[1,2,3,4,5].map(v=>{
            const active = value===v ? "scale-option active" : "scale-option";
            const label = v===1 ? "å…¨ããã†æ€ã‚ãªã„" : (v===5 ? "ã¨ã¦ã‚‚ãã†æ€ã†" : "");
            return `
              <label class="${active}">
                <input type="radio" name="${q.id}" value="${v}" ${value===v ? "checked":""}/>
                <span>${v}</span>
                ${label ? `<span class="muted small">${label}</span>` : ""}
              </label>
            `;
          }).join("")}
        </div>
        <div class="scale-caption">1: å…¨ããã†æ€ã‚ãªã„ ã€œ 5: ã¨ã¦ã‚‚ãã†æ€ã†</div>
      </div>
    `;
  }).join("");

  const prevBtn = document.getElementById("prev-page-btn");
  const nextBtn = document.getElementById("next-page-btn");
  prevBtn.disabled = currentIndex===0;
  nextBtn.textContent = (endIndex>=total) ? "çµæœã‚’è¦‹ã‚‹ ğŸ¯" : "æ¬¡ã¸ â†’";

  // âœ… ã“ã“ãŒå›ç­”changeã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä»˜ã‘ã¦ã‚‹å ´æ‰€
  container.querySelectorAll("input[type='radio']").forEach(input=>{
    input.addEventListener("change", (e)=>{
      const qid = e.target.name;
      const val = Number(e.target.value);
      answers[qid]=val;

      renderQuizPage(); // activeè¡¨ç¤ºæ›´æ–°

      if(!autoNext) return;

      if(pageSize===1){
        setTimeout(()=>goNextPageOrResult(), 180);
        return;
      }

      const pageQuestions = QUESTIONS.slice(currentIndex, endIndex);
      const missing = pageQuestions.some(q=>!answers[q.id]);

      const currentEl = document.querySelector(`.question[data-qid="${qid}"]`);
      const allEls = Array.from(document.querySelectorAll("#quiz-questions-container .question"));
      const idx = allEls.findIndex(el=>el===currentEl);
      const nextEl = allEls[idx+1];
      if(nextEl) nextEl.scrollIntoView({behavior:"smooth", block:"center"});

      if(!missing){
        setTimeout(()=>goNextPageOrResult(), 220);
      }
    });
  });
}

function goNextPageOrResult(){
  const total = QUESTIONS.length;
  const endIndex = Math.min(currentIndex + pageSize, total);
  if(endIndex >= total){
    if(!allQuestionsAnswered()) return;

    const scores = calculateScores();
    const type = determineType(scores);
    const actions = getActions(scores);

    const item = {
      timestamp: Date.now(),
      user: currentUserDisplay,
      scores,
      typeCode: type.code,
      typeLabel: type.label
    };
    saveHistoryItem(item);

    renderResult(scores, type, actions);
    renderHistoryUserSelect(currentUserDisplay);
    renderHistoryList(getHistoryViewingUser());
    drawHistoryChart(getHistoryViewingUser());
    showSection("result-section");
    window.scrollTo({top:0, behavior:"smooth"});
    return;
  }
  currentIndex = endIndex;
  renderQuizPage();
}

/******************************************************************
 * çµæœæç”»ï¼ˆæœ€çŸ­ã®1æ‰‹ è¿½åŠ ï¼‰
 ******************************************************************/
function renderResult(scores, typeInfo, actions, meta={}){
  lastResult = {scores, typeInfo, actions, meta};

  const typeBlock = document.getElementById("result-type-block");
  const scoresBlock = document.getElementById("result-scores-block");
  const actionsBlock = document.getElementById("result-actions-block");
  const tradeoff = document.getElementById("tradeoff-line");
  const modeDesc = document.getElementById("mode-description");
  const shareInput = document.getElementById("share-text");
  const shortestBox = document.getElementById("shortest-move-box");

  let chips = "";
  if(typeInfo.kind==="pair"){
    chips = `
      <span class="badge-chip">${AXIS_EMOJI[typeInfo.topAxis]} æœ€å¤§åŒ–: ${AXIS_LABELS[typeInfo.topAxis]}</span>
      <span class="badge-chip">${AXIS_EMOJI[typeInfo.lowAxis]} çŠ ç‰²: ${AXIS_LABELS[typeInfo.lowAxis]}</span>
    `;
  }else{
    chips = `<span class="badge-chip">ğŸ§© ç‰¹æ®Šã‚¿ã‚¤ãƒ—ï¼š4è»¸åŒç‚¹</span>`;
  }

  const when = meta?.timestamp ? `<div class="muted small" style="margin-top:.3rem;">ï¼ˆå±¥æ­´ã®å†è¡¨ç¤ºï¼š${formatDateTime(meta.timestamp)}ï¼‰</div>` : "";

  typeBlock.innerHTML = `
    <div class="type-title">${typeInfo.label}</div>
    <div class="type-code">ã‚³ãƒ¼ãƒ‰: <strong>${typeInfo.code}</strong></div>
    <div class="muted" style="margin-top:.25rem;">${typeInfo.vibe || ""}</div>
    <div style="margin-top:.35rem;">${chips}</div>
    ${typeInfo.kind==="tie" ? `<div class="muted small" style="margin-top:.35rem;">ãƒ’ãƒ³ãƒˆï¼š${typeInfo.hint || ""}</div>` : ""}
    ${when}
  `;

  tradeoff.textContent = makeTradeoffLine(typeInfo);
  modeDesc.textContent = (currentMode==="dark") ? (typeInfo.dark||"") : (typeInfo.awake||"");

  // âœ… æœ€çŸ­ã®1æ‰‹ï¼ˆé—‡è½ã¡ã‚’æ­¢ã‚ã‚‹ï¼‰
  const move = getShortestMove(typeInfo);
  shortestBox.style.display = "";
  shortestBox.innerHTML = `ğŸ›‘ é—‡è½ã¡ãƒ«ãƒ¼ãƒˆã‚’æ­¢ã‚ã‚‹ â€œæœ€çŸ­ã®1æ‰‹â€ ï¼š<br/><b>${move}</b>`;

  scoresBlock.innerHTML = `
    <div class="small">
      <div>${AXIS_EMOJI.H} H: ${scores.H}</div>
      <div>${AXIS_EMOJI.E} E: ${scores.E}</div>
      <div>${AXIS_EMOJI.S} S: ${scores.S}</div>
      <div>${AXIS_EMOJI.R} R: ${scores.R}</div>
    </div>
  `;

  actionsBlock.innerHTML = actions.map(a=>`<li>${a}</li>`).join("");

  const modeLabel = currentMode==="dark" ? "é—‡è½ã¡ç‰ˆ" : "è¦šé†’ç‰ˆ";
  const shareText =
    `Well-BTIè¨ºæ–­ï¼ˆ${currentUserDisplay||"åç„¡ã—"}ï¼‰ï¼š${typeInfo.label}ï¼ˆ${modeLabel}ï¼‰ï½œH:${scores.H}, E:${scores.E}, S:${scores.S}, R:${scores.R}ï½œ${tradeoff.textContent}`;
  shareInput.value = shareText;

  drawRadar(scores);
}

/******************************************************************
 * ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ‡æ›¿
 ******************************************************************/
function showSection(sectionId){
  ["onboarding-section","quiz-section","result-section","history-section"].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.style.display = (id===sectionId) ? "" : "none";
  });
  document.querySelectorAll(".nav-btn").forEach(btn=>{
    const t=btn.getAttribute("data-target");
    btn.classList.toggle("active", t===sectionId);
  });

  if(sectionId==="history-section"){
    renderHistoryUserSelect(getHistoryViewingUser());
    renderHistoryList(getHistoryViewingUser());
    drawHistoryChart(getHistoryViewingUser());
  }
}

/******************************************************************
 * åˆæœŸåŒ–
 ******************************************************************/
document.addEventListener("DOMContentLoaded", ()=>{
  // nav
  document.querySelectorAll(".nav-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const target=btn.getAttribute("data-target");
      if(target) showSection(target);
    });
  });

  // consent
  const toggleConsent=document.getElementById("toggle-consent");
  const startBtn=document.getElementById("start-quiz-btn");
  const nameInput=document.getElementById("user-name");

  function canStart(){
    const hasName = normalizeName(nameInput.value).length>0;
    const hasConsent = toggleConsent.classList.contains("on");
    startBtn.disabled = !(hasName && hasConsent);
  }

  function setConsent(on){
    toggleConsent.classList.toggle("on",on);
    toggleConsent.setAttribute("aria-checked", on?"true":"false");
    canStart();
  }

  nameInput.addEventListener("input", ()=>{
    canStart();
  });

  toggleConsent.addEventListener("click", ()=>setConsent(!toggleConsent.classList.contains("on")));
  toggleConsent.addEventListener("keydown", (e)=>{
    if(e.key===" "||e.key==="Enter"){ e.preventDefault(); setConsent(!toggleConsent.classList.contains("on")); }
  });

  // analytics
  const toggleAnalytics=document.getElementById("toggle-analytics");
  function setAnalytics(on){
    toggleAnalytics.classList.toggle("on",on);
    toggleAnalytics.setAttribute("aria-checked", on?"true":"false");
    analyticsEnabled=on;
    logEvent("analytics_toggle",{enabled:on});
  }
  toggleAnalytics.addEventListener("click", ()=>setAnalytics(!toggleAnalytics.classList.contains("on")));
  toggleAnalytics.addEventListener("keydown", (e)=>{
    if(e.key===" "||e.key==="Enter"){ e.preventDefault(); setAnalytics(!toggleAnalytics.classList.contains("on")); }
  });

  // page size toggle
  const togglePage=document.getElementById("toggle-page-size");
  const pageLabel=document.getElementById("page-size-label");
  function setPageSize(on){
    togglePage.classList.toggle("on",on);
    togglePage.setAttribute("aria-checked", on?"true":"false");
    pageSize = on ? 4 : 1;
    pageLabel.textContent = on ? "4å•ãšã¤" : "1å•ãšã¤";
    currentIndex = 0;
    renderQuizPage();
  }
  togglePage.addEventListener("click", ()=>setPageSize(!togglePage.classList.contains("on")));
  togglePage.addEventListener("keydown", (e)=>{
    if(e.key===" "||e.key==="Enter"){ e.preventDefault(); setPageSize(!togglePage.classList.contains("on")); }
  });

  // auto next toggle
  const toggleAuto=document.getElementById("toggle-auto-next");
  const autoLabel=document.getElementById("auto-next-label");
  function setAuto(on){
    toggleAuto.classList.toggle("on",on);
    toggleAuto.setAttribute("aria-checked", on?"true":"false");
    autoNext = on;
    autoLabel.textContent = on ? "ON" : "OFF";
  }
  setAuto(true);
  toggleAuto.addEventListener("click", ()=>setAuto(!toggleAuto.classList.contains("on")));
  toggleAuto.addEventListener("keydown", (e)=>{
    if(e.key===" "||e.key==="Enter"){ e.preventDefault(); setAuto(!toggleAuto.classList.contains("on")); }
  });

  // start
  startBtn.addEventListener("click", ()=>{
    const name = normalizeName(document.getElementById("user-name").value);
    if(!name){ alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
    setCurrentUser(name);

    const onboarding={
      user: currentUserDisplay,
      ageGroup: document.getElementById("age-group").value || null,
      grade: document.getElementById("grade").value || null,
      chronotype: document.getElementById("chronotype").value || null,
      consentResearch: toggleConsent.classList.contains("on")
    };
    localStorage.setItem(ONBOARDING_KEY, JSON.stringify(onboarding));
    logEvent("start_quiz", onboarding);

    answers = {};
    currentIndex = 0;
    showSection("quiz-section");
    renderQuizPage();
    window.scrollTo({top:0, behavior:"smooth"});
  });

  // prev/next
  document.getElementById("prev-page-btn").addEventListener("click", ()=>{
    currentIndex = Math.max(0, currentIndex - pageSize);
    renderQuizPage();
    window.scrollTo({top:0, behavior:"smooth"});
  });
  document.getElementById("next-page-btn").addEventListener("click", ()=>{
    const total = QUESTIONS.length;
    const endIndex = Math.min(currentIndex + pageSize, total);
    const slice = QUESTIONS.slice(currentIndex, endIndex);
    const missing = slice.filter(q=>!answers[q.id]);
    if(missing.length){
      alert("ã“ã®ãƒšãƒ¼ã‚¸ã®ã™ã¹ã¦ã®è³ªå•ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    if(endIndex >= total){
      if(!allQuestionsAnswered()){
        alert("ã¾ã å›ç­”ã—ã¦ã„ãªã„è³ªå•ãŒã‚ã‚Šã¾ã™ã€‚");
        return;
      }
      const scores = calculateScores();
      const type = determineType(scores);
      const actions = getActions(scores);
      const item = { timestamp: Date.now(), user: currentUserDisplay, scores, typeCode:type.code, typeLabel:type.label };
      saveHistoryItem(item);
      renderResult(scores, type, actions);

      renderHistoryUserSelect(currentUserDisplay);
      renderHistoryList(currentUserDisplay);
      drawHistoryChart(currentUserDisplay);

      showSection("result-section");
      window.scrollTo({top:0, behavior:"smooth"});
    }else{
      currentIndex = endIndex;
      renderQuizPage();
      window.scrollTo({top:0, behavior:"smooth"});
    }
  });

  // mode toggle
  const btnAwake=document.getElementById("mode-awake");
  const btnDark=document.getElementById("mode-dark");
  function setMode(mode){
    currentMode = mode;
    btnAwake.classList.toggle("active", mode==="awake");
    btnDark.classList.toggle("active", mode==="dark");
    if(lastResult){
      renderResult(lastResult.scores, lastResult.typeInfo, lastResult.actions, lastResult.meta);
    }
  }
  btnAwake.addEventListener("click", ()=>setMode("awake"));
  btnDark.addEventListener("click", ()=>setMode("dark"));

  // share
  document.getElementById("copy-share-btn").addEventListener("click", async ()=>{
    const txt = document.getElementById("share-text").value;
    try{ await navigator.clipboard.writeText(txt); alert("è¨ºæ–­çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚"); }
    catch{ alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚"); }
  });
  document.getElementById("native-share-btn").addEventListener("click", async ()=>{
    const txt = document.getElementById("share-text").value;
    if(navigator.share){
      try{ await navigator.share({text:txt, title:"Well-BTIè¨ºæ–­"}); }catch(e){}
    }else{
      alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Web Share APIã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚");
    }
  });

  // jump to history
  document.getElementById("jump-history-btn").addEventListener("click", ()=>{
    showSection("history-section");
    window.scrollTo({top:0, behavior:"smooth"});
  });

  // history user select change
  const historySelect = document.getElementById("history-user-select");
  historySelect.addEventListener("change", ()=>{
    renderHistoryList(getHistoryViewingUser());
    drawHistoryChart(getHistoryViewingUser());
  });

  // set as current user
  document.getElementById("set-as-current-user-btn").addEventListener("click", ()=>{
    const n = getHistoryViewingUser();
    if(!n){ alert("åå‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }
    setCurrentUser(n);
    alert(`ç¾åœ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã€Œ${n}ã€ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸã€‚`);
    updateCurrentUserBadge();
  });

  // clear history (for selected name)
  document.getElementById("clear-history-btn").addEventListener("click", ()=>{
    const name = getHistoryViewingUser();
    if(!name){ alert("åå‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }
    if(!confirm(`ã€Œ${name}ã€ã®å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å†…ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼‰`)) return;
    clearHistoryFor(name);
    renderHistoryList(name);
    drawHistoryChart(name);
  });

  // initial: load current user + user index into selector
  loadCurrentUser();
  updateCurrentUserBadge();

  // onboarding: ä»¥å‰ã®currentUserãŒã‚ã‚Œã°åå‰æ¬„ã«å…¥ã‚Œã¦ãŠã
  if(currentUserDisplay){
    nameInput.value = currentUserDisplay;
  }
  canStart();

  renderHistoryUserSelect(currentUserDisplay || "");
  renderHistoryList(getHistoryViewingUser());
  drawHistoryChart(getHistoryViewingUser());
});
</script>
</body>
</html>
